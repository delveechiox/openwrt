name: OpenWrt SSH Menuconfig Build

on:
  workflow_dispatch:

jobs:
  menuconfig:
    name: SSH into GitHub runner to run menuconfig
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext libncurses-dev libssl-dev \
          python3-distutils rsync unzip zlib1g-dev file wget

    - name: Clone OpenWrt
      run: |
        git clone https://github.com/openwrt/openwrt.git
        cd openwrt
        echo "src-git kenzo https://github.com/xiaorouji/openwrt-passwall" >> feeds.conf.default
        echo "src-git passwall_packages https://github.com/xiaorouji/openwrt-passwall-packages" >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Start SSH session via tmate
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true  # 仅你自己能登录 SSH

